# FIX: –ó–≤—É–∫–æ–≤—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø—Ä–∏ Force Flush

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ª—ã—à–∞–ª **–∑–≤—É–∫–æ–≤—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã** –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö:

1. **"JSI tangible"** - —Å—Ç—Ä–∞–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ
2. **"address"** - –æ–±—Ä—ã–≤–∞–ª–æ—Å—å
3. **"Optimization deep deeper dive about with large"** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ü–æ—Å–º–æ—Ç—Ä–µ–≤ –Ω–∞ –ª–æ–≥–∏, —è –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø–∞—Ç—Ç–µ—Ä–Ω:

```
WARN  ‚ö†Ô∏è [SENTENCE] Force flush (max duration: 2508ms)
LOG  üì¶ [AudioQueue] Preloading: ...stream_chunk_1770330231656_5.wav
LOG  ‚úÖ [AudioQueue] Enqueued (total: 6)
...
LOG  üîÑ [AudioQueue] Starting SCHEDULED cross-fade (120ms)
WARN  ‚ö†Ô∏è [SENTENCE] Force flush (max duration: 2508ms)
...
LOG  üö´ [AudioQueue] Cancelling scheduled crossfade (file finished first)
LOG  ‚úÖ [AudioQueue] Chunk 7 finished (duration: 2410ms)
LOG  ‚è∏Ô∏è [AudioQueue] Adding 20ms micro-pause (no crossfade)
```

### –ü—Ä–∏—á–∏–Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤:

1. **Force flush** —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª—ã –ë–ï–ó –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
2. `enqueue()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å `sentenceChunk = undefined`
3. `shouldUseCrossfade()` –≤–æ–∑–≤—Ä–∞—â–∞–ª `true` (–¥–ª—è backward compatibility)
4. Crossfade –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª—Å—è –Ω–∞ 120ms –æ—Ç –∫–æ–Ω—Ü–∞ —Ñ–∞–π–ª–∞
5. **–ù–û —Ñ–∞–π–ª –∑–∞–∫–∞–Ω—á–∏–≤–∞–ª—Å—è —Ä–∞–Ω—å—à–µ** ‚Üí crossfade –æ—Ç–º–µ–Ω—è–ª—Å—è
6. –î–æ–±–∞–≤–ª—è–ª–∞—Å—å —Ä–µ–∑–∫–∞—è –ø–∞—É–∑–∞ 20ms
7. –≠—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ **–∑–≤—É–∫–æ–≤–æ–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç** - —Å–ª–æ–≤–æ –æ–±—Ä—ã–≤–∞–ª–æ—Å—å –∏–ª–∏ –∑–≤—É—á–∞–ª–æ —Å—Ç—Ä–∞–Ω–Ω–æ

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ò–∑–º–µ–Ω–∏–ª –ª–æ–≥–∏–∫—É –≤ `shouldUseCrossfade()`:

```typescript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
if (!current.sentenceChunk) {
    return true;  // ‚Üê –≠—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ crossfade –¥–∞–∂–µ –¥–ª—è Force flush!
}

// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
if (!current.sentenceChunk) {
    console.log(`‚ö†Ô∏è [Crossfade] No sentence metadata (Force flush?), skipping crossfade for safety`);
    return false;  // ‚Üê –¢–µ–ø–µ—Ä—å –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º crossfade –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É:

1. **Force flush —Ñ–∞–π–ª—ã** (–±–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö) —Ç–µ–ø–µ—Ä—å **–ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç crossfade**
2. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–º–∏–∫—Ä–æ-–ø–∞—É–∑–∞ 20ms**
3. –ú–∏–∫—Ä–æ-–ø–∞—É–∑–∞ **–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ** - –Ω–µ—Ç —Ä–∏—Å–∫–∞ –æ–±—Ä—ã–≤–∞ —Å–ª–æ–≤–∞ –ø–æ—Å—Ä–µ–¥–∏ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
4. –°–ª–æ–≤–∞ –∑–≤—É—á–∞—Ç **—á–µ—Ç–∫–æ**, –±–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
File A (Force flush) ‚Üí [–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è crossfade 120ms]
                     ‚Üí —Ñ–∞–π–ª –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ
                     ‚Üí crossfade –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
                     ‚Üí —Ä–µ–∑–∫–∞—è –ø–∞—É–∑–∞
                     ‚Üí –ê–†–¢–ï–§–ê–ö–¢ ‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
File A (Force flush) ‚Üí [crossfade –ù–ï –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è]
                     ‚Üí —Ñ–∞–π–ª –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                     ‚Üí –º–∏–∫—Ä–æ-–ø–∞—É–∑–∞ 20ms
                     ‚Üí —á–∏—Å—Ç—ã–π –∑–≤—É–∫ ‚úÖ
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –°–ª—É—à–∞–π—Ç–µ –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã Victoria, –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç Force flush
3. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏:
   ```
   ‚ö†Ô∏è [Crossfade] No sentence metadata (Force flush?), skipping crossfade for safety
   ‚è∏Ô∏è [AudioQueue] Adding 20ms micro-pause (no crossfade)
   ```
4. –ó–≤—É–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **—á–∏—Å—Ç—ã–º**, –±–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–¢–æ–ª—å–∫–æ Force flush —Ñ–∞–π–ª—ã** –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã —ç—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
- **–û–±—ã—á–Ω—ã–µ —Ñ–∞–π–ª—ã —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏** –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π crossfade
- –≠—Ç–æ **zero-risk –∏–∑–º–µ–Ω–µ–Ω–∏–µ** - –º—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—Ç–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å crossfade —Ç–∞–º, –≥–¥–µ –Ω–µ –∑–Ω–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ!** –¢–µ–ø–µ—Ä—å Force flush —Ñ–∞–π–ª—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –º–∏–∫—Ä–æ-–ø–∞—É–∑—É –≤–º–µ—Å—Ç–æ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ–≥–æ crossfade.
