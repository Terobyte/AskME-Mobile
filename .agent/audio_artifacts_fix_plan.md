# –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∑–≤—É–∫–∞

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ—è–≤–ª–µ–Ω–∏–µ
- **–ì–¥–µ**: –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (–∫–ª–∏–∫–∏/—Ä–∞–∑—Ä—ã–≤—ã) –Ω–∞ —Å–ª–æ–≤–∞—Ö "key", "touch upon", "highlights", "through"
- **–ö–æ–≥–¥–∞**: –í–Ω—É—Ç—Ä–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –í–∏–∫—Ç–æ—Ä–∏–∏, –ù–ï –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- **–•–∞—Ä–∞–∫—Ç–µ—Ä**: –°–ª—ã—à–∏—Ç—Å—è —Ä–∞–∑—Ä—ã–≤ –∏–ª–∏ "–¥–≤–æ–µ–Ω–∏–µ" –≥–æ–ª–æ—Å–∞

### üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ–¥–∞

#### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê ‚Ññ1: Race Condition –≤ `playCurrent()` (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
**–§–∞–π–ª**: `streaming-audio-player.ts`, —Å—Ç—Ä–æ–∫–∏ 119-264

**–°—É—Ç—å**:
```typescript
// –°—Ç—Ä–æ–∫–∞ 214: –ó–∞–ø—É—Å–∫–∞–µ–º crossfade –ø–æ —Ç–∞–π–º–µ—Ä—É
crossFadeTimeout = setTimeout(async () => {
    if (!crossFadeStarted) {
        crossFadeStarted = true;
        // –°—Ç—Ä–æ–∫–∞ 226: –ó–∞–ø—É—Å–∫–∞–µ–º –°–õ–ï–î–£–Æ–©–ò–ô —á–∞–Ω–∫
        await next.sound.playAsync();
        
        // –°—Ç—Ä–æ–∫–∏ 230-241: –î–µ–ª–∞–µ–º fade –∑–∞ 120–º—Å
        for (let i = 1; i <= fadeSteps; i++) {
            await Promise.all([
                current.sound.setVolumeAsync(1.0 - progress),
                next.sound.setVolumeAsync(progress)
            ]);
        }
    }
}, triggerTime); // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞ 120–º—Å –î–û –∫–æ–Ω—Ü–∞ —Ñ–∞–π–ª–∞

// –ù–û!
// –°—Ç—Ä–æ–∫–∞ 144: didJustFinish –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å –†–ê–ù–¨–®–ï –∏–ª–∏ –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û
if (status.didJustFinish) {
    // –°—Ç—Ä–æ–∫–∞ 148: –û—Ç–º–µ–Ω—è–µ–º crossfade
    if (crossFadeTimeout) {
        clearTimeout(crossFadeTimeout);
    }
    // –°—Ç—Ä–æ–∫–∞ 163: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π
    this.currentIndex++;
    // –°—Ç—Ä–æ–∫–∞ 183: –ó–∞–ø—É—Å–∫–∞–µ–º playCurrent() –°–ù–û–í–ê
    this.playCurrent();
}
```

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. **–°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏**: `setTimeout` –∏ `didJustFinish` –º–æ–≥—É—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **–î–≤–æ–π–Ω–æ–π –∑–∞–ø—É—Å–∫**: –°–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –î–í–ê–ñ–î–´:
   - –û–¥–∏–Ω —Ä–∞–∑ –∏–∑ `crossFadeTimeout` (—Å—Ç—Ä–æ–∫–∞ 226)
   - –í—Ç–æ—Ä–æ–π —Ä–∞–∑ –∏–∑ `playCurrent()` (—Å—Ç—Ä–æ–∫–∞ 183 ‚Üí 201)
3. **–†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤**: `didJustFinish` –≤—ã–∑—ã–≤–∞–µ—Ç `playCurrent()`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –Ω–æ–≤—ã–π `didJustFinish`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: "–î–≤–æ–µ–Ω–∏–µ" –≥–æ–ª–æ—Å–∞, –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ –≥–∏–ø–æ—Ç–µ–∑–µ ‚Ññ4

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê ‚Ññ2: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π Crossfade –±–µ–∑ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ç–∏—à–∏–Ω—ã (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
**–§–∞–π–ª**: `streaming-audio-player.ts`, —Å—Ç—Ä–æ–∫–∏ 66, 209-250

**–°—É—Ç—å**:
```typescript
private readonly CROSSFADE_MS = 120; // –í—Å–µ–≥–¥–∞ 120–º—Å

// –°—Ç—Ä–æ–∫–∞ 209: –ó–∞–ø—É—Å–∫–∞–µ–º crossfade –∑–∞ 120–º—Å –¥–æ –∫–æ–Ω—Ü–∞
const triggerTime = status.durationMillis - this.CROSSFADE_MS;

// –°—Ç—Ä–æ–∫–∏ 234-237: –°–º–µ—à–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–∞
await Promise.all([
    current.sound.setVolumeAsync(1.0 - progress), // –¢–µ–∫—É—â–∏–π –∑–∞—Ç—É—Ö–∞–µ—Ç
    next.sound.setVolumeAsync(progress)           // –°–ª–µ–¥—É—é—â–∏–π –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç
]);
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ö—Ä–æ—Å—Å—Ñ–µ–π–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –í–°–ï–ì–î–ê, –¥–∞–∂–µ –µ—Å–ª–∏ –º–µ–∂–¥—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –Ω–µ—Ç –ø–∞—É–∑—ã
- –ï—Å–ª–∏ –í–∏–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç "...working with, You can also..." –ë–ï–ó –ø–∞—É–∑—ã, —Ç–æ:
  - –ü–æ—Å–ª–µ–¥–Ω–∏–µ 120–º—Å –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞: "with, You"
  - –ü–µ—Ä–≤—ã–µ 120–º—Å –≤—Ç–æ—Ä–æ–≥–æ —Ñ–∞–π–ª–∞: "You can also"
  - –ü–æ–ª—É—á–∞–µ—Ç—Å—è: "with, You" + "You can" = —Å–ª—ã—à–Ω–æ "Youuuu" (—É–¥–≤–æ–µ–Ω–∏–µ)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –Ω–∞ —Å—Ç—ã–∫–∞—Ö, –∫–∞–∫ –≤ –≥–∏–ø–æ—Ç–µ–∑–µ ‚Ññ2

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê ‚Ññ3: –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
**–§–∞–π–ª**: `streaming-audio-player.ts`, —Å—Ç—Ä–æ–∫–∏ 141-184

**–°—É—Ç—å**:
```typescript
// –°—Ç—Ä–æ–∫–∞ 141: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º callback
current.sound.setOnPlaybackStatusUpdate(async (status) => {
    if (status.didJustFinish) {
        // –°—Ç—Ä–æ–∫–∞ 160: –£–¥–∞–ª—è–µ–º callback
        current.sound.setOnPlaybackStatusUpdate(null);
        
        // –°—Ç—Ä–æ–∫–∞ 163: –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π
        this.currentIndex++;
        
        // –°—Ç—Ä–æ–∫–∞ 166: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–≥—Ä–∞–µ—Ç –ª–∏ —É–∂–µ —Å–ª–µ–¥—É—é—â–∏–π
        if (next && crossFadeStarted) {
            const nextStatus = await next.sound.getStatusAsync();
            if (nextStatus.isLoaded && nextStatus.isPlaying) {
                // –°—Ç—Ä–æ–∫–∞ 172: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω—É—é –≥—Ä–æ–º–∫–æ—Å—Ç—å
                await next.sound.setVolumeAsync(1.0);
                // –°—Ç—Ä–æ–∫–∞ 174: –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º
                this.playCurrent();
                return;
            }
        }
        
        // –°—Ç—Ä–æ–∫–∞ 183: Fallback - –∑–∞–ø—É—Å–∫–∞–µ–º —Å–Ω–æ–≤–∞
        this.playCurrent();
    }
});

// –°—Ç—Ä–æ–∫–∞ 201: –ó–∞–ø—É—Å–∫–∞–µ–º –¢–ï–ö–£–©–ò–ô —Ñ–∞–π–ª
await current.sound.playAsync();
```

**–ü—Ä–æ–±–ª–µ–º—ã**:
1. `didJustFinish` –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
2. –ú–µ–∂–¥—É `didJustFinish` –∏ `playCurrent()` –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ 10-50–º—Å
3. –ï—Å–ª–∏ `crossFadeTimeout` —Å—Ä–∞–±–æ—Ç–∞–ª –†–ê–ù–¨–®–ï `didJustFinish`, —Ç–æ:
   - –°–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª —É–∂–µ –∏–≥—Ä–∞–µ—Ç (—Å—Ç—Ä–æ–∫–∞ 226)
   - `didJustFinish` –≤—ã–∑—ã–≤–∞–µ—Ç `playCurrent()` (—Å—Ç—Ä–æ–∫–∞ 174)
   - `playCurrent()` –≤—ã–∑—ã–≤–∞–µ—Ç `playAsync()` –°–ù–û–í–ê (—Å—Ç—Ä–æ–∫–∞ 201)
   - –ü–æ–ª—É—á–∞–µ—Ç—Å—è: –¥–≤–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–≥—Ä–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –æ—Ç "—Ñ–∞–∑–æ–≤–æ–≥–æ —Å–¥–≤–∏–≥–∞", –∫–∞–∫ –≤ –≥–∏–ø–æ—Ç–µ–∑–µ ‚Ññ4

---

### ‚ÑπÔ∏è –ü–†–û–ë–õ–ï–ú–ê ‚Ññ4: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±—É—Ñ–µ—Ä (–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
**–§–∞–π–ª**: `streaming-config.ts`, —Å—Ç—Ä–æ–∫–∞ 16

**–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**:
```typescript
minBufferMs: parseInt(process.env.EXPO_PUBLIC_CARTESIA_STREAMING_MIN_BUFFER_MS || '200')
```

**–ê–Ω–∞–ª–∏–∑**:
- `200–º—Å` –±—É—Ñ–µ—Ä –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞
- –§–∞–π–ª—ã –ø–æ ~1250–º—Å (FAST_START) –∏–ª–∏ ~500-2500–º—Å (SENTENCE_MODE)
- –ö –º–æ–º–µ–Ω—Ç—É —Å–ª–æ–≤–∞ "key" (~5-—è —Å–µ–∫—É–Ω–¥–∞) —É –Ω–∞—Å —É–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
- **–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è –¥–ª—è –æ–ø–∏—Å–∞–Ω–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã

---

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Race Condition (–ö—Ä–∏—Ç–∏—á–Ω–æ)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –í—ã—Å–æ–∫–∏–π

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `AudioQueue.playCurrent()`**:
1. –í–≤–µ—Å—Ç–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (`_isTransitioning` —Ñ–ª–∞–≥)
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `crossFadeTimeout` –∏ `didJustFinish` –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç
3. –î–æ–∂–¥–∞—Ç—å—Å—è –ü–û–õ–ù–û–ì–û –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è crossfade –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `playCurrent()`

**–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏**:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥
private _isTransitioning: boolean = false;

// –í didJustFinish:
if (status.didJustFinish) {
    // –ï—Å–ª–∏ crossfade —É–∂–µ –∏–¥–µ—Ç, –ù–ï –≤—ã–∑—ã–≤–∞–µ–º playCurrent()
    if (this._isTransitioning) {
        console.log('‚è≠Ô∏è Transition already in progress, skipping');
        return;
    }
    
    // –û—Ç–º–µ–Ω—è–µ–º scheduled crossfade
    if (crossFadeTimeout) {
        clearTimeout(crossFadeTimeout);
        crossFadeTimeout = null;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
    this._isTransitioning = true;
    
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ ...
    
    // –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    this._isTransitioning = false;
}

// –í crossFadeTimeout:
crossFadeTimeout = setTimeout(async () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ —Ñ–∞–π–ª —É–∂–µ
    if (this._isTransitioning) {
        console.log('‚è≠Ô∏è File already finished, skipping crossfade');
        return;
    }
    
    this._isTransitioning = true;
    
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ crossfade ...
    
    // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è crossfade
    this._isTransitioning = false;
    
    // –í–ê–ñ–ù–û: –ù–ï –≤—ã–∑—ã–≤–∞–µ–º playCurrent() –∑–¥–µ—Å—å!
    // –ñ–¥–µ–º didJustFinish –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
}, triggerTime);
```

---

### –§–∞–∑–∞ 2: –î–µ—Ç–µ–∫—Ü–∏—è —Ç–∏—à–∏–Ω—ã –¥–ª—è Crossfade (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π

**–ü–æ–¥—Ö–æ–¥**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å timestamp –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—É–∑

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
1. –í `createChunkFile()` —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 200–º—Å —Ñ–∞–π–ª–∞
2. –ü—Ä–æ–≤–µ—Ä—è—Ç—å, –µ—Å—Ç—å –ª–∏ "—Ç–∏—à–∏–Ω–∞" (–ø–∞—É–∑–∞ \u003e 100–º—Å –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏)
3. –ü—Ä–∏–º–µ–Ω—è—Ç—å crossfade –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞

**–ö–æ–¥**:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É
interface QueueItem {
    sound: Audio.Sound;
    filepath: string;
    isPreloaded: boolean;
    hasSilenceAtEnd?: boolean; // –ù–û–í–û–ï
}

// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞
private async createChunkFile(...) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º timestamps –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 200–º—Å
    const hasSilence = this.detectSilenceAtEnd(chunks);
    
    this.queue[fileIndex].hasSilenceAtEnd = hasSilence;
}

// –ù–æ–≤—ã–π –º–µ—Ç–æ–¥
private detectSilenceAtEnd(chunks: AudioChunk[]): boolean {
    // –ï—Å–ª–∏ –Ω–µ—Ç timestamps, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Ç–∏—à–∏–Ω—É –ù–ï–¢
    if (this.incomingTimestamps.length === 0) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200–º—Å –∞—É–¥–∏–æ
    const duration = calculateAudioDuration(...);
    const lastWords = this.incomingTimestamps.filter(
        t => t.timestampSeconds * 1000 > duration - 200
    );
    
    // –ï—Å–ª–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 200–º—Å –µ—Å—Ç—å —Å–ª–æ–≤–∞, —Ç–∏—à–∏–Ω—ã –ù–ï–¢
    return lastWords.length === 0;
}

// –í playCurrent()
if (next) {
    const useCrossfade = current.hasSilenceAtEnd ?? true;
    
    if (useCrossfade) {
        // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π crossfade –∫–æ–¥
    } else {
        console.log('‚è≠Ô∏è Skipping crossfade (no silence)');
        // –ü—Ä–æ—Å—Ç–æ –∂–¥–µ–º didJustFinish
    }
}
```

---

### –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –í—ã—Å–æ–∫–∏–π

**–ü–æ–¥—Ö–æ–¥**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Promise –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å promise –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è
private playCurrentPromise: Promise<void> | null = null;

private async playCurrent(): Promise<void> {
    // –ï—Å–ª–∏ —É–∂–µ –∏–≥—Ä–∞–µ–º, –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    if (this.playCurrentPromise) {
        console.log('‚è∏Ô∏è Waiting for previous playCurrent to finish...');
        await this.playCurrentPromise;
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π promise
    this.playCurrentPromise = new Promise(async (resolve) => {
        try {
            // ... –≤—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ ...
            
            // –í –∫–æ–Ω—Ü–µ:
            resolve();
        } catch (error) {
            resolve(); // –ó–∞–≤–µ—Ä—à–∞–µ–º –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        } finally {
            this.playCurrentPromise = null;
        }
    });
    
    await this.playCurrentPromise;
}
```

---

### –§–∞–∑–∞ 4: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ minBufferMs (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –ù–∏–∑–∫–∏–π

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```typescript
// –í .env –∏–ª–∏ streaming-config.ts
minBufferMs: 300 // –ë—ã–ª–æ: 200
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –±—É—Ñ–µ—Ä –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] **–§–∞–∑–∞ 1**: –î–æ–±–∞–≤–∏—Ç—å `_isTransitioning` —Ñ–ª–∞–≥
- [ ] **–§–∞–∑–∞ 1**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç `crossFadeTimeout` –∏ `didJustFinish`
- [ ] **–§–∞–∑–∞ 3**: –î–æ–±–∞–≤–∏—Ç—å `playCurrentPromise` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
- [ ] **–§–∞–∑–∞ 2**: –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é —Ç–∏—à–∏–Ω—ã (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è)
- [ ] **–§–∞–∑–∞ 4**: –£–≤–µ–ª–∏—á–∏—Ç—å `minBufferMs` –¥–æ 300 (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è)

---

## üß™ –ì–∏–ø–æ—Ç–µ–∑—ã ‚Üí –†–µ—à–µ–Ω–∏—è

| –ì–∏–ø–æ—Ç–µ–∑–∞ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –†–µ—à–∞–µ—Ç—Å—è —Ñ–∞–∑–æ–π |
|---------|-------------|----------------|
| –ì–∏–ø–æ—Ç–µ–∑–∞ ‚Ññ4 (Race Condition) | ‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è (70%) | –§–∞–∑–∞ 1 + –§–∞–∑–∞ 3 |
| –ì–∏–ø–æ—Ç–µ–∑–∞ ‚Ññ2 (–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π Crossfade) | ‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è (70%) | –§–∞–∑–∞ 2 |
| –ì–∏–ø–æ—Ç–µ–∑–∞ ‚Ññ3 (–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è) | ‚ö†Ô∏è –°—Ä–µ–¥–Ω—è—è (50%) | –§–∞–∑–∞ 1 + –§–∞–∑–∞ 3 |
| –ì–∏–ø–æ—Ç–µ–∑–∞ ‚Ññ1 (Buffer Starvation) | ‚ö†Ô∏è –ù–∏–∑–∫–∞—è (30%) | –§–∞–∑–∞ 4 |

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ù–µ—Ç "–¥–≤–æ–µ–Ω–∏—è" –≥–æ–ª–æ—Å–∞
- ‚úÖ –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏
- ‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–ª–æ–≤–∞—Ö "key", "touch upon", etc.
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ gapless playback
