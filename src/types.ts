export type InterviewMode = 'short' | 'medium' | 'long' | 'freestyle';

export interface CategorizedSkill {
  skill: string;
  category: string;
  score?: number;
  question_script?: string; // <--- NEW: The generated scenario/question
}

export interface GeminiAnalysisResult {
  matches: CategorizedSkill[];
  gaps: CategorizedSkill[];
  cool_skills: CategorizedSkill[];
  transferable_skills: CategorizedSkill[];
  soft_skills: CategorizedSkill[]; // <--- Changed from string[] to Object
  job_role?: string;
}

export interface InterviewTopic {
  id: string;
  type: 'Match' | 'Gap' | 'SoftSkill' | 'CoolSkill' | 'Intro' | 'Outro';
  topic: string;
  category?: string; // Added for grouping
  context: string; // This field will now store the DEEP SCENARIO generated by Pro
  estimated_time: string;
  score?: number; // Added Relevance Score
}

export interface InterviewPlan {
  meta: {
    mode: InterviewMode;
    total_estimated_time: string;
    isInfinite?: boolean;
    new_question_ids?: string[];
  };
  queue: InterviewTopic[];
}

export interface EvaluationMetrics {
  accuracy: number;
  depth: number;
  structure: number;
  reasoning: string;
}

// ============================================
// ENHANCED EVALUATION SYSTEM TYPES
// ============================================

/**
 * QualityLevel: Semantic representation of answer quality.
 * Maps compositeScore to human-readable levels for decision-making.
 * 
 * Score Mapping:
 * - excellent: 9.0-10.0 (expert-level, specific examples, deep understanding)
 * - good: 7.0-8.9 (solid practical experience, correct terminology)
 * - mediocre: 5.0-6.9 (textbook understanding, lacks real-world depth)
 * - poor: 3.0-4.9 (weak/confused understanding, vague)
 * - fail: 0.0-2.9 (fundamentally wrong but attempting)
 */
export type QualityLevel = 'excellent' | 'good' | 'mediocre' | 'poor' | 'fail';

/**
 * AnswerIssue: Specific problems identified in the candidate's answer.
 * Used to provide targeted feedback and help Victoria guide the conversation.
 */
export type AnswerIssue =
  | 'NO_EXAMPLE'        // Didn't provide concrete example
  | 'WRONG_CONCEPT'     // Fundamental misunderstanding
  | 'TOO_VAGUE'         // Answer lacks specificity
  | 'OFF_TOPIC'         // Didn't answer the question asked
  | 'RAMBLING'          // Unfocused, jumping between ideas
  | 'INCOMPLETE'        // Started well but didn't finish thought
  | 'SHALLOW';          // Surface-level, no depth

/**
 * UserIntent: Extended intent types for more granular classification.
 * Separates quality attempts (STRONG_ATTEMPT vs WEAK_ATTEMPT) from actions.
 * 
 * Intent Behavior:
 * - STRONG_ATTEMPT: Good quality attempt (compositeScore >= 5) â†’ normal flow
 * - WEAK_ATTEMPT: Poor quality attempt (compositeScore < 5) â†’ patience increases
 * - CLARIFICATION: Request for rephrasing â†’ metrics zeroed, stay on topic
 * - GIVE_UP: Admit not knowing â†’ move to next topic, slight patience
 * - SHOW_ANSWER: Request explanation â†’ educational transition (OLD)
 * - SHOW_ANSWER_STAY: Request explanation â†’ stay on topic, retry same question (NEW)
 * - SHOW_ANSWER_PREVIOUS: Go back to previous â†’ explain, retry previous (NEW)
 * - NONSENSE: Off-topic trolling â†’ triggers anger increase
 * - READY_CONFIRM: User says "ready" â†’ intro phase only
 */
export type UserIntent =
  | 'STRONG_ATTEMPT'    // Good quality attempt (score >= 5)
  | 'WEAK_ATTEMPT'      // Poor quality attempt (score < 5)
  | 'CLARIFICATION'     // Asking for question to be rephrased
  | 'GIVE_UP'           // Admitting don't know, skip
  | 'SHOW_ANSWER'       // Request to reveal correct answer (OLD: explain + transition)
  | 'SHOW_ANSWER_STAY'  // Request explanation + retry same question (NEW)
  | 'SHOW_ANSWER_PREVIOUS' // Go back to previous + explain (NEW)
  | 'NONSENSE'          // Off-topic trolling
  | 'READY_CONFIRM';    // User says "ready" (intro only)

/**
 * AnalysisResponse: Enhanced evaluation result with multi-dimensional analysis.
 * 
 * Key improvements over previous version:
 * - compositeScore: Weighted average for decision-making
 * - level: Semantic quality level for human-readable feedback
 * - issues: Specific problems for targeted feedback
 * - suggestedFeedback: Pre-generated phrase for Victoria's voice
 */
export interface AnalysisResponse {
  // Keep existing metrics for transparency and detailed logging
  metrics: EvaluationMetrics;

  // NEW: Composite score (weighted based on question type)
  // Technical: accuracyÃ—0.5 + depthÃ—0.3 + structureÃ—0.2
  // SoftSkill: accuracyÃ—0.3 + depthÃ—0.3 + structureÃ—0.4
  // Intro: accuracyÃ—0.2 + depthÃ—0.2 + structureÃ—0.6
  compositeScore: number;  // 0-10, calculated by combining metrics

  // NEW: Semantic quality level
  level: QualityLevel;

  // NEW: Specific problems identified
  issues: AnswerIssue[];

  // Intent classification using extended types
  intent: UserIntent;

  // NEW: Suggested feedback snippet for Victoria
  // Short phrase (5-10 words) that Victoria should incorporate naturally
  suggestedFeedback: string;
}

export interface VoiceGenerationContext {
  currentTopic: InterviewTopic;
  nextTopic: InterviewTopic | null;
  transitionMode: 'STAY' | 'NEXT_FAIL' | 'NEXT_PASS' | 'NEXT_EXPLAIN' | 'FINISH_INTERVIEW' | 'TERMINATE_ANGER';
  angerLevel?: number;           // Added for final feedback
  engagementLevel?: number;      // NEW: Engagement metric (0-100)
  vibe?: VibeConfig;             // NEW: Current emotional state
}

export interface AiResponse {
  message: string;
  metrics: EvaluationMetrics;
}

export interface ChatMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp?: number;
}

export interface InterviewContext {
  currentTopic: InterviewTopic;
  previousResult: string | null;
  angerLevel: number;
  isLastTopic: boolean;
}

export interface QuestionResult {
  topic: string;
  userAnswer: string;
  score: number; // 0-10
  feedback: string;
  detailedFeedback?: string; // âœ¨ NEW: Comprehensive 4-6 sentence feedback with actionable advice
  advice?: string; // âœ¨ NEW: Generated study advice (2-3 sentences)
  metrics?: EvaluationMetrics; // Optional for backward compatibility
  compositeScore?: number; // NEW: Weighted average (0-10)
  level?: QualityLevel; // NEW: Semantic quality level
  issues?: AnswerIssue[]; // NEW: Specific problems identified
  intent?: UserIntent; // NEW: User's intent classification
  suggestedFeedback?: string; // NEW: Short phrase for Victoria (5-10 words)
  rawExchange?: Array<{ // âœ¨ NEW: Raw Q&A for debug section
    speaker: 'Victoria' | 'User';
    text: string;
    timestamp?: number;
  }>;
}

export interface FinalInterviewReport {
  questions: QuestionResult[];
  averageScore: number;
  overallSummary: string;
  timestamp: number;
  wasForceFinished?: boolean; // âœ¨ NEW: True if manually force-finished via shake menu
  terminationReason?: 'completed' | 'force_finished' | 'anger_limit' | 'patience_limit'; // âœ¨ NEW: How interview ended
}

// ============================================
// EMOTION & VIBE SYSTEM TYPES
// ============================================

/**
 * CartesiaEmotion: Emotion values supported by Cartesia API
 * Reference: https://docs.cartesia.ai/api-reference/tts/bytes
 */
export type CartesiaEmotion =
  | 'neutral'
  | 'positivity:lowest'
  | 'positivity:low'
  | 'positivity:high'
  | 'positivity:highest'
  | 'anger:lowest'
  | 'anger:low'
  | 'anger:high'
  | 'anger:highest'
  | 'sadness:lowest'
  | 'sadness:low'
  | 'sadness:high'
  | 'sadness:highest'
  | 'surprise:lowest'
  | 'surprise:low'
  | 'surprise:high'
  | 'surprise:highest'
  | 'curiosity:lowest'
  | 'curiosity:low'
  | 'curiosity:high'
  | 'curiosity:highest';

/**
 * VibeLabel: 15 emotional states for Victoria based on anger/engagement
 */
export type VibeLabel =
  // Positive vibes (low anger, high engagement)
  | 'Impressed'       // anger 0-10, engagement 80-100
  | 'Encouraging'     // anger 0-10, engagement 50-79
  | 'Professional'    // anger 11-25, engagement 60-100

  // Neutral vibes (medium anger, varying engagement)
  | 'Neutral'         // anger 11-25, engagement 30-59
  | 'Curious'         // anger 26-40, engagement 60-100
  | 'Concerned'       // anger 26-40, engagement 30-59

  // Negative mild (medium anger, low engagement or special cases)
  | 'Disappointed'    // anger 26-40, engagement 0-29
  | 'Skeptical'       // anger 41-60, engagement 40-100
  | 'Amused'          // anger 41-60, absurd error detected

  // Negative strong (high anger)
  | 'Irritated'       // anger 41-60, engagement 0-39
  | 'Frustrated'      // anger 61-70
  | 'Hostile'         // anger 71-85
  | 'Dismissive'      // anger 86-90
  | 'Furious';        // anger 91-100

/**
 * VibeConfig: Complete configuration for an emotional state
 */
export interface VibeConfig {
  label: VibeLabel;
  cartesiaEmotion: CartesiaEmotion;
  speed: number;                    // Speech rate (0.5 - 1.5)
  emotionLevel?: string[];          // Cartesia emotion array format
  promptModifier: string;           // Instructions for Gemini voice generation
  description: string;              // Human-readable explanation
}

/**
 * CartesiaTTSRequest: Cartesia API request structure
 * Reference: https://docs.cartesia.ai/api-reference/tts/bytes
 */
export interface CartesiaTTSRequest {
  model_id: string;                 // 'sonic-english'
  transcript: string;               // Text to speak (NOT "text")
  voice: {
    mode: 'id';
    id: string;
    __experimental_controls?: {
      speed?: string;               // 'slowest' | 'slow' | 'normal' | 'fast' | 'fastest'
      emotion?: string[];           // Array of emotion strings
    };
  };
  output_format: {
    container: 'mp3' | 'wav';
    encoding: 'mp3' | 'pcm_s16le' | 'pcm_f32le' | 'pcm_mulaw';
    sample_rate: number;
  };
}

// ============================================
// TTS PROVIDER TYPES
// ============================================

/**
 * TTSProvider: Text-to-Speech provider selection
 */
export type TTSProvider = 'cartesia' | 'openai' | 'deepgram';

/**
 * OpenAI TTS Model
 * gpt-4o-mini-tts - newest, supports instructions, recommended
 * tts-1 - lower latency
 * tts-1-hd - higher quality
 */
export type OpenAITTSModel = 'gpt-4o-mini-tts' | 'tts-1' | 'tts-1-hd';

/**
 * OpenAIVoice: Available voices for OpenAI TTS
 * Updated 2025-02 - Now 13 voices total
 * marin and cedar recommended for best quality
 */
export type OpenAIVoice =
  | 'alloy'   // Ð¡Ð±Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹
  | 'ash'     // NEW - Soft, calm voice
  | 'ballad'  // NEW - Expressive, musical quality
  | 'coral'   // NEW - Cheerful, upbeat tone
  | 'echo'    // ÐœÑƒÐ¶ÑÐºÐ¾Ð¹, Ð¼ÑÐ³ÐºÐ¸Ð¹
  | 'fable'   // ÐœÑƒÐ¶ÑÐºÐ¾Ð¹, Ð±Ñ€Ð¸Ñ‚Ð°Ð½ÑÐºÐ¸Ð¹
  | 'nova'    // Ð–ÐµÐ½ÑÐºÐ¸Ð¹, Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹
  | 'onyx'    // ÐœÑƒÐ¶ÑÐºÐ¾Ð¹, Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¹
  | 'sage'    // NEW - Warm, storytelling voice
  | 'shimmer' // Ð–ÐµÐ½ÑÐºÐ¸Ð¹, Ð¼ÑÐ³ÐºÐ¸Ð¹
  | 'verse'   // NEW - Energetic, dynamic tone
  | 'marin'   // NEW - â­ Best quality recommended
  | 'cedar';  // NEW - â­ Best quality recommended

/**
 * DeepgramVoice: Available Aura voices for Deepgram TTS
 * Reference: https://developers.deepgram.com/docs/tts-models
 */
export type DeepgramVoice =
  | 'aura-2-thalia-en'    // Energetic, Enthusiastic (F)
  | 'aura-2-athena-en'    // Calm, Professional (F)
  | 'aura-2-hermes-en'    // Expressive, Knowledgeable (M)
  | 'aura-2-orion-en'     // Approachable, Calm (M)
  | 'aura-2-luna-en'      // Friendly, Engaging (F)
  | 'aura-2-arcas-en';    // Natural, Smooth (M)

// ============================================
// PDF RESUME SUPPORT TYPES
// ============================================

/**
 * ResumeData: Ð¢Ð¸Ð¿ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ PDF Ñ€ÐµÐ·ÑŽÐ¼Ðµ
 * ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ PDF Ñ„Ð°Ð¹Ð» Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð² Gemini API
 */
export interface ResumeData {
  /** Fallback Ñ‚ÐµÐºÑÑ‚ (Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¸Ð»Ð¸ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚) */
  text: string;

  /** Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ðº PDF Ñ„Ð°Ð¹Ð»Ñƒ */
  pdfUri: string;

  /** Base64 ÐºÐ¾Ð´ PDF (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð´Ð»Ñ inline data) */
  pdfBase64?: string;

  /** Ð¤Ð»Ð°Ð³: Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒ PDF Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð² Gemini */
  usePdfDirectly: boolean;

  /** Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð° Ð² Ð±Ð°Ð¹Ñ‚Ð°Ñ… (Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¼ÐµÑ‚Ð¾Ð´Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸) */
  fileSize?: number;
}

// ============================================
// STREAMING TTS TYPES
// ============================================

/**
 * AudioChunk: Single chunk of PCM audio data from WebSocket stream
 */
export interface AudioChunk {
  data: ArrayBuffer;        // PCM audio data
  timestamp: number;        // When received (Date.now())
  sequence: number;         // Sequential number (0, 1, 2, ...)
  sizeBytes: number;        // Chunk size in bytes

  // Optional sentence metadata (if using sentence chunking)
  sentenceMetadata?: {
    sentence: string;
    isSentenceBoundary: boolean;
    durationMs: number;
  };
}

// ============================================
// SENTENCE CHUNKING TYPES
// ============================================

/**
 * WordTimestamp: Word timing from Cartesia API
 */
export interface WordTimestamp {
  word: string;
  start: number;  // seconds from audio start
  end: number;    // seconds from audio start
}

/**
 * SentenceBoundary: Detected sentence boundary from timestamps
 */
export interface SentenceBoundary {
  sentence: string;
  startTime: number;  // seconds
  endTime: number;    // seconds
  wordCount: number;
}

/**
 * SentenceChunk: PCM data for a single sentence
 */
export interface SentenceChunk {
  pcmData: ArrayBuffer;
  sentence: string;
  startTimeSeconds: number;
  endTimeSeconds: number;
  durationMs: number;
  wordCount: number;
}

/**
 * Cartesia WebSocket message types
 */
export interface CartesiaChunkMessage {
  type: 'chunk';
  context_id: string;
  data: string; // base64 encoded PCM
}

export interface CartesiaTimestampsMessage {
  type: 'timestamps';
  context_id: string;
  word_timestamps: {
    words: string[];
    start: number[];
    end: number[];
  };
  done: boolean;
}

export interface CartesiaDoneMessage {
  type: 'done';
  context_id: string;
}

export interface CartesiaErrorMessage {
  type: 'error';
  context_id: string;
  error: string;
}

export type CartesiaMessage =
  | CartesiaChunkMessage
  | CartesiaTimestampsMessage
  | CartesiaDoneMessage
  | CartesiaErrorMessage;

// ============================================
// DEEPGRAM TTS TYPES
// ============================================

/**
 * Deepgram streaming options
 */
export interface DeepgramStreamingOptions {
  voiceId: DeepgramVoice;
  text: string;
  encoding?: 'linear16' | 'mulaw' | 'opus';
  sampleRate?: number;

  // Callbacks
  onChunk?: (chunk: AudioChunk) => void;
  onComplete?: () => void;
  onError?: (error: Error) => void;
  onFirstChunk?: (latency: number) => void;
}

// ============================================
// OPENAI TTS TYPES
// ============================================

/**
 * OpenAI Streaming Options
 */
export interface OpenAIStreamingOptions {
  voiceId: OpenAIVoice;
  text: string;
  model?: OpenAITTSModel;
  speed?: number; // 0.25 - 4.0
  instructions?: string; // ðŸ†• Voice style instructions (gpt-4o-mini-tts only)
  onChunk?: (chunk: AudioChunk) => void;
  onFirstChunk?: (latency: number) => void;
}

/**
 * OpenAI Stream Config
 */
export interface OpenAIStreamConfig {
  apiKey: string;
  model?: OpenAITTSModel;
  voiceId: OpenAIVoice;
  speed?: number;
  instructions?: string; // ðŸ†• Voice style instructions
}

/**
 * StreamingPlayerState: Current state of the streaming audio player
 */
export type StreamingPlayerState =
  | 'idle'        // Not active
  | 'connecting'  // Connecting to WebSocket
  | 'buffering'   // Accumulating minimum buffer
  | 'playing'     // Playing audio
  | 'completed'   // Generation completed
  | 'error';      // Error occurred

/**
 * StreamingPlayerConfig: Configuration for streaming audio player
 */
export interface StreamingPlayerConfig {
  minBufferMs: number;      // Minimum buffer before starting (200ms)
  targetBufferMs: number;   // Target buffer size (1000ms)
  chunkSampleRate: number;  // Sample rate in Hz (16000)
  maxRetries: number;       // Max reconnection attempts (3)
  strategy: 'hybrid' | 'chunked';  // From PoC results
}

/**
 * CartesiaStreamingOptions: Options for WebSocket streaming generation
 */
export interface CartesiaStreamingOptions {
  voiceId: string;
  text: string;
  emotion?: string[];
  speed?: 'slowest' | 'slow' | 'normal' | 'fast' | 'fastest';

  // Callbacks
  onChunk?: (chunk: AudioChunk) => void;
  onComplete?: () => void;
  onError?: (error: Error) => void;
  onFirstChunk?: (latency: number) => void;
  onTimestampsReceived?: (timestamps: WordTimestamp[]) => void;  // PHASE 2: Real-time timestamps
}

/**
 * StreamingMetrics: Performance metrics for streaming playback
 */
export interface StreamingMetrics {
  generationStart: number;    // Timestamp of start
  firstChunkTime: number | null;  // Timestamp of first chunk
  firstPlayTime: number | null;   // Timestamp of playback start
  totalChunks: number;        // Total chunk count
  totalBytes: number;         // Total bytes received
  bufferUnderruns: number;    // Number of buffer underruns
  averageChunkSize: number;   // Average chunk size in bytes

  // Calculated getters
  get timeToFirstChunk(): number | null;
  get timeToFirstPlay(): number | null;
  get totalLatency(): number | null;
}
